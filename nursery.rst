======================
保育園の人気状況可視化
======================

このハンズオンでは、芦屋市の保育園の人気状況を可視化します。

完成イメージ
============

https://drive.google.com/open?id=1fR4asCfi52_p59sE35Pp3bUkXLk&usp=sharing

.. image:: images/visualization-of-nursery.png

元になるデータ
==============

以下の2つのページから収集したデータを結合して、地図上に可視化します。

* `芦屋市／芦屋市内の保育施設・定員一覧 <http://www.city.ashiya.lg.jp/kodomo/ichiran_02.html>`_
* `芦屋市／保育所等の申し込み状況 <http://www.city.ashiya.lg.jp/kodomo/moushikomijyoukyou2704.html>`_


1. 保育所一覧を取得する
=======================

まず `保育所の一覧 <http://www.city.ashiya.lg.jp/kodomo/ichiran_02.html>`_ を取得します。

1-1. Webページから表を取得する
------------------------------

Googleスプレッドシートでは、 ``IMPORTHTML()`` 関数でWebページの表をスプレッドシートに取り込めます。

新しく作成したスプレッドシートの ``A1`` セルに以下のように入力します。 ::

    =IMPORTHTML("http://www.city.ashiya.lg.jp/kodomo/ichiran_02.html", "table", 1)

``IMPORTHTML()`` 関数は配列を返します。Googleスプレッドシートで配列を返す関数を使うと、以下のように式を入力した ``A1`` セル以外にも値が表示されます。

.. image:: images/nursery/step1-1.png

``IMPORTHTML()`` 関数に指定する引数は次の意味を表します。 ::

    =IMPORTHTML(<WebページのURL>, <"table" (表) または"list" (リスト)>, <ページ内での登場順序>)

2番目の表を取得したい場合は、以下のようにします。 ::

    =IMPORTHTML("http://www.city.ashiya.lg.jp/kodomo/ichiran_02.html", "table", 2)

.. note::

    この程度であればHTMLの表をコピーして貼り付けても同じだと思われるかもしれません。
    コピー&ペーストとIMPORTHTML()関数の大きな違いは、更新への対応です。
    IMPORTHTML()関数を使うと、Webページが更新された時に人間が作業をすることなく最新の情報を取得できます。

1-2. 複数の表を取得して結合する
-------------------------------

このページでは保育所の情報がカテゴリ（市立・私立・認定こども園・小規模保育事業所）ごとに4つの表に分かれています。
市立保育所だけでなく、全カテゴリの保育所を取得したいです。

空いているA8セルに2番目の表を取り込むのも一つの案ですが、そうすると保育所の数が変化した時に困ります。
例えば、市立保育所の数が6→7に増えた場合、空白行が足りないので、市立保育所の取得結果が展開されなくなります。

複数の配列を縦に結合するには、 ``={ 配列1; 配列2; 配列3; 配列4 }`` という表記を使います。
``A1`` セルに以下のように入力します（読みやすくするために改行していますが、入力の際はなくても構いません）。 ::

    ={IMPORTHTML("http://www.city.ashiya.lg.jp/kodomo/ichiran_02.html", "table", 1);
      IMPORTHTML("http://www.city.ashiya.lg.jp/kodomo/ichiran_02.html", "table", 2);
      IMPORTHTML("http://www.city.ashiya.lg.jp/kodomo/ichiran_02.html", "table", 3);
      IMPORTHTML("http://www.city.ashiya.lg.jp/kodomo/ichiran_02.html", "table", 4)}

4つの表が結合された状態で表示されます。

.. image:: images/nursery/step1-2.png

1-3. 取得した表のデータを整える
-------------------------------

このデータは後で他のシートから参照したいので、シート名を ``保育所一覧`` に変更しておきます。

また、データを見ると若干扱いづらい点があります。

1. 施設名に※がついているものがある
2. 所在地が町名から始まるローカルな住所である

これを直します。A列の左側に2列挿入し、以下のように入力します。

=== ============================ =========================
    A                            B
=== ============================ =========================
1   名前                         住所
2    ``=SUBSTITUTE(C2,"※","")``  ``="兵庫県芦屋市" & D2``
=== ============================ =========================

SUBSTITUTE()関数は第1引数の文字列から第2引数の文字列を探し、それをすべて第3引数に置き換えた文字列を得ます。 ``"※"`` を ``""`` （空文字）に置き換えることで、不要な※を削除します。 ::

    =SUBSTITUTE(<対象の文字列>, <探す文字列>, <置き換える文字列>)

演算子の ``&`` は左右の文字列を結合します。先頭に兵庫県芦屋市をつけることで、Googleマップでも正しく認識される住所にします。

入力できたらA2:B2セルを選択し、表の一番下の行までドラッグします。
※がついていた施設名から※が取り除かれていることがわかります。

.. image:: images/nursery/step1-3.png

.. note::

    8行目など、表のヘッダーだった行の住所は変な値になりますが、気にしなくて大丈夫です。

2. 保育所の申込状況を取得する
==============================

続いて、 `保育所の申込状況 <http://www.city.ashiya.lg.jp/kodomo/moushikomijyoukyou2704.html>`_ を取得します。

2-1. データ内容の確認
---------------------

まずWebページでデータを見てみましょう。

.. image:: images/nursery/step2-1.png

この表には施設ごとに第1希望の申込数と内定数が掲載されています。
カッコに囲われてない数字が第1希望の申込数で、カッコで囲われた数が内定数です。
人気状況を可視化するにあたって、一番右の合計の列を見ることにします。

``第1希望の申込数 > 内定数`` の保育所は入所しづらく、 ``第1希望の申込数 < 内定数`` の保育所は入所しやすいと言えるでしょう。

.. note::

    カッコ書きの数字がない保育所は、内定者が0、つまりまったく空きがないということになります。
    誰も第1希望としなかったものの、内定者がいる保育所はカッコ書きの数字のみが記載されています。


2-2. 申込状況の取得
--------------------

では確認したデータを取得します。
新しくシートを作成し、 ``申込状況`` という名前をつけます。

A1セルに以下のように入力します。 ::

    =IMPORTHTML("http://www.city.ashiya.lg.jp/kodomo/moushikomijyoukyou2704.html", "table", 1)

.. image:: images/nursery/step2-2.png

取得結果を見ると、 ``(1)`` と書かれていたセルが ``-1`` と認識されているなど、意図しない変換がなされています。
残念ながらIMPORTHTML()関数でこれを回避する方法はありません。
この程度であれば許容範囲なので、このまま進めます。

2-3. 第1希望の申込数と内定数を分離する
--------------------------------------

合計の列（I列）のデータは2つの意味を持つデータが同じセルに含まれていて扱いづらいので、これを分離します。


